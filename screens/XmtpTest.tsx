import * as SecureStore from "expo-secure-store";
import React, { useEffect } from "react";
import { View } from "react-native";

import config from "../config";
import { Client, Conversation } from "../vendor/xmtp-js/index";

const xmtpEnv = config.xmtpEnv === "production" ? "production" : "dev";

const getMessages = async (conversation: Conversation) => {
  const now = new Date().getTime();
  const messages = await conversation.messages();
  const after = new Date().getTime();
  const duration = (after - now) / 1000;
  console.log(`Getting ${messages.length} messages took ${duration} seconds`);
};

export default function XmtpTest() {
  useEffect(() => {
    const loadKeys = async () => {
      const keys = await SecureStore.getItemAsync("XMTP_KEYS");
      if (!keys) return;
      const client = await Client.create(null, {
        privateKeyOverride: Buffer.from(JSON.parse(keys)),
        env: xmtpEnv,
      });
      const now = new Date().getTime();
      await client.conversations.import(JSON.parse(conversationsExport));
      console.log("Getting the conversations...");
      const convos = await client.conversations.list();
      console.log(`Done - ${convos.length} convos`);
      await Promise.all(convos.map(getMessages));
      const after = new Date().getTime();
      const duration = (after - now) / 1000;
      console.log(`Took ${duration} seconds`);
    };
    loadKeys();
  }, []);
  return <View />;
}

const conversationsExport =
  '[{"version":"v1","peerAddress":"0xf9a3BB070c1f9b3186A547DeD991BeD04a289C5B","createdAt":"2022-09-20T09:32:50.329Z"},{"version":"v1","peerAddress":"0x4496848684441C15A915fa9bF07D131155603253","createdAt":"2022-11-03T11:40:55.595Z"},{"version":"v1","peerAddress":"0xf39Fd6e51aad88F6F4ce6aB8827279cffFb92266","createdAt":"2022-11-15T14:55:48.297Z"},{"version":"v1","peerAddress":"0x03bF6ecAfffe166c3dd685d82eDB239fCf665826","createdAt":"2022-11-15T15:03:37.042Z"},{"version":"v2","topic":"/xmtp/0/m-N+Gxytl+fwBm5iGj+NN44lWjCpuOhBK986K0SpBUaTs/proto","keyMaterial":"+h0XgAojn/cA98XSF1mex0tT7F2lJTxTW0vkwkTjpy0=","peerAddress":"0x02D1F5947159f88b78dbdd62DE63cB5c3B734285","createdAt":"2022-12-05T19:22:32.590Z","context":{"conversationId":"lens.dev/dm/0x47b9-0x5aee","metadata":{}}},{"version":"v2","topic":"/xmtp/0/m-mD6Et0zCVP2SVZsCeTEbWJCIpTMdWIaw0XPNkfnAltU/proto","keyMaterial":"TiTp/K6aBSeOBqo/znXTyOIonteQqtDr/MY2CvKDMAc=","peerAddress":"0x4496848684441C15A915fa9bF07D131155603253","createdAt":"2022-12-05T19:26:19.858Z","context":{"conversationId":"lens.dev/dm/0x5aee-0x5af3","metadata":{}}},{"version":"v2","topic":"/xmtp/0/m-EoeuEdWu-SNgy5c2A1Xn9pDYuDb21yIZ0MsuQ/lOQzQ/proto","keyMaterial":"pKh90yI7PfYl37ZvY9vmstgPkyozoKwPldbXxtj3QLs=","peerAddress":"0xB1E617957847720c4F62Aa81622846f8D6a1ecA1","createdAt":"2022-12-23T07:55:40.785Z"},{"version":"v2","topic":"/xmtp/0/m-RibkUZH1BxDstCVYvFLIUY5yInxfoyCYK6F-VcP84xs/proto","keyMaterial":"FvCck17xe6lFOmpW/R+8A0ox3gz9hvsOZ8KbuJ289Wc=","peerAddress":"0xf9a3BB070c1f9b3186A547DeD991BeD04a289C5B","createdAt":"2023-01-03T12:04:18.859Z","context":{"conversationId":"test-noe-1","metadata":{}}},{"version":"v2","topic":"/xmtp/0/m-J3ix3AQTGary2lyX3UJBq8tGmYPfWKNMSwBUech1AoY/proto","keyMaterial":"i1aD8gV7MWw+ULZqz2Y2/2+LbKf6le8TS1tYZDHDgQY=","peerAddress":"0xf9a3BB070c1f9b3186A547DeD991BeD04a289C5B","createdAt":"2023-01-03T12:22:57.803Z","context":{"conversationId":"test-noe-2","metadata":{}}},{"version":"v2","topic":"/xmtp/0/m-d-5fnaMEbhl0Q5UGDyeYsj3eUFalpRTRgqFf0Oh/C/g/proto","keyMaterial":"ioXycN0dYLsJ/Kjg1H0t2K0DD9vem/VRpDFh6L3TezU=","peerAddress":"0xf9a3BB070c1f9b3186A547DeD991BeD04a289C5B","createdAt":"2023-01-03T12:42:47.713Z","context":{"conversationId":"noetest.xyz/dm/0x2376-0xf9a3/1","metadata":{}}},{"version":"v2","topic":"/xmtp/0/m-LkBeyatwE5a1yJNa2RbKZBeD+OducXyz0XJuEyMMqGU/proto","keyMaterial":"crBrO7woe3qQ2pbsaYNTxRlBjeY7LKIIQmJ4YLqxTDU=","peerAddress":"0xf9a3BB070c1f9b3186A547DeD991BeD04a289C5B","createdAt":"2023-01-03T14:33:54.351Z","context":{"conversationId":"getconverse.app/dm/0x2376-0xf9a3/1","metadata":{}}},{"version":"v2","topic":"/xmtp/0/m-ETE+u+FLJnT67q-YW1eeTjYAxksIV3ejUAwg4qMc8e8/proto","keyMaterial":"EoK2kXpZ40fNfF/7T+9CEf5zbSDltMf67A202ZfNn4g=","peerAddress":"0xf9a3BB070c1f9b3186A547DeD991BeD04a289C5B","createdAt":"2023-01-03T14:36:56.495Z","context":{"conversationId":"getconverse.app/dm/0x2376-0xf9a3/2","metadata":{}}},{"version":"v2","topic":"/xmtp/0/m-XkAHyej3hrEWI-WNCsPf2fqhcKzvsjUB0N2f1lWchBw/proto","keyMaterial":"uu5BjWhlQ70q9w94wblUUwAsHr7lsjiRmg6dgQcVQyY=","peerAddress":"0x4496848684441C15A915fa9bF07D131155603253","createdAt":"2023-01-04T08:56:10.151Z","context":{"conversationId":"getconverse.app/dm/0x2376-0x4496/1","metadata":{}}},{"version":"v2","topic":"/xmtp/0/m-5uKYws0jCvS0cy24nuOXVy1m59XO1j66F71m98SEx4M/proto","keyMaterial":"kcTOGCz59DjeNHpGFRbahxNbkN/x9p/qFM8ic8XBpcw=","peerAddress":"0xf9a3BB070c1f9b3186A547DeD991BeD04a289C5B","createdAt":"2023-01-04T15:29:08.972Z","context":{"conversationId":"getconverse.app/dm/0x2376-0xf9a3/3","metadata":{}}},{"version":"v2","topic":"/xmtp/0/m-PgwEvdBoEnD8RHy8BAI2lrp6c5CkVMgSa3H23cHn7zw/proto","keyMaterial":"wX4jqm9MZ/uldOC0p5KsIiI/+wt5Ya1QPW06ikGS9ns=","peerAddress":"0xf9a3BB070c1f9b3186A547DeD991BeD04a289C5B","createdAt":"2023-01-04T15:36:44.341Z","context":{"conversationId":"getconverse.app/dm/0x2376-0xf9a3/4","metadata":{}}},{"version":"v2","topic":"/xmtp/0/m-YShewk8HyNwuPPKH-Li2lrvvr+c5nGvIX1OZ/h5mpDc/proto","keyMaterial":"OSBwInANfGQ4zxqIPw1RVv/gDJnv0sN5tgVobifVtFs=","peerAddress":"0xf9a3BB070c1f9b3186A547DeD991BeD04a289C5B","createdAt":"2023-01-04T15:50:48.540Z","context":{"conversationId":"getconverse.app/dm/0x2376-0xf9a3/5","metadata":{}}},{"version":"v2","topic":"/xmtp/0/m-Y+0m8eYtylMwdZosk9k00rHPYGx0gju12G6ZCmHmrCc/proto","keyMaterial":"fIwNUUf7CNwpAJutcYM6gwAfE1WvuUbNhEFfAyfhX/g=","peerAddress":"0xf9a3BB070c1f9b3186A547DeD991BeD04a289C5B","createdAt":"2023-01-04T15:54:38.183Z","context":{"conversationId":"getconverse.app/dm/0x2376-0xf9a3/6","metadata":{}}},{"version":"v2","topic":"/xmtp/0/m-4V6qEa7gbRS-2tsXFc2OU8tK+UpOgWz0o0ecjhUSPcc/proto","keyMaterial":"EYYKabTbxLhEtURjzxsk/PAIXI9FpnUppyN5kJ63qx0=","peerAddress":"0xf9a3BB070c1f9b3186A547DeD991BeD04a289C5B","createdAt":"2023-01-04T15:55:41.028Z","context":{"conversationId":"getconverse.app/dm/0x2376-0xf9a3/7","metadata":{}}},{"version":"v2","topic":"/xmtp/0/m-JBXaMmt6hteag6KA3wb-qhD5dvxdUYF8sZxCXev2HK8/proto","keyMaterial":"b0mH5uD138m1q4k/hUolLYuYgX+lT5QxNbIEObaV+ss=","peerAddress":"0xf9a3BB070c1f9b3186A547DeD991BeD04a289C5B","createdAt":"2023-01-04T15:56:31.192Z","context":{"conversationId":"getconverse.app/dm/0x2376-0xf9a3/8","metadata":{}}},{"version":"v2","topic":"/xmtp/0/m-2OUEmLwPaHMP7dxNj4d-lAxGXgM6XwiAkfrJzWwVq2U/proto","keyMaterial":"BfPxCPRtSMide/Bg5D6TaNwdRvvBcpbO6u6GiBFBBek=","peerAddress":"0xf9a3BB070c1f9b3186A547DeD991BeD04a289C5B","createdAt":"2023-01-04T15:57:13.798Z","context":{"conversationId":"getconverse.app/dm/0x2376-0xf9a3/9","metadata":{}}},{"version":"v2","topic":"/xmtp/0/m-G-4nBG2GCJ1TxRoOA1yo3ll4wiSQpY6CSPZLkhRac+s/proto","keyMaterial":"ewNmX3EJ2iJXyYQSUSyBmx2zK1K+PbgNOgDWwosCBCc=","peerAddress":"0xf9a3BB070c1f9b3186A547DeD991BeD04a289C5B","createdAt":"2023-01-04T15:58:54.407Z","context":{"conversationId":"getconverse.app/dm/0x2376-0xf9a3/10","metadata":{}}},{"version":"v2","topic":"/xmtp/0/m-YiLLMsmyE5fbTYHmCv78wAunZyPzEGaMoDsv6shevuk/proto","keyMaterial":"LXw9YI22PVN4MLwdpZq+oHLVkn5x+btN7Ai2YgX4VR8=","peerAddress":"0xf9a3BB070c1f9b3186A547DeD991BeD04a289C5B","createdAt":"2023-01-04T16:08:46.769Z","context":{"conversationId":"getconverse.app/dm/0x2376-0xf9a3/11","metadata":{}}},{"version":"v2","topic":"/xmtp/0/m-0qi4vZh4nsQ7n34ofUZr-4rKx43yYVdnxMUsxl26yjE/proto","keyMaterial":"yoI+g81dy8rXncNr1Bx5y0qCOvrp78cYlD90r2OaDhQ=","peerAddress":"0xf9a3BB070c1f9b3186A547DeD991BeD04a289C5B","createdAt":"2023-01-04T16:11:15.615Z","context":{"conversationId":"getconverse.app/dm/0x2376-0xf9a3/12","metadata":{}}},{"version":"v2","topic":"/xmtp/0/m-p+2jkUAHiZI-heibjmXjN4kCD083hLUWqTsqbjzBPFo/proto","keyMaterial":"lBkOYQuQcx4hz4gKGNLlXvDP7hkfRXdFKO0g8sxIZIM=","peerAddress":"0xf9a3BB070c1f9b3186A547DeD991BeD04a289C5B","createdAt":"2023-01-04T16:18:22.740Z","context":{"conversationId":"getconverse.app/dm/0x2376-0xf9a3/13","metadata":{}}},{"version":"v2","topic":"/xmtp/0/m-h1r3N2iHsvWhdDSXDf0e-MTiOUupgGFrNhxxjRlJAyc/proto","keyMaterial":"bnwYpBsR22c1MelvmKa3/azTPGJiQA1wuaRe4+IWLLg=","peerAddress":"0xf9a3BB070c1f9b3186A547DeD991BeD04a289C5B","createdAt":"2023-01-04T16:21:32.594Z","context":{"conversationId":"getconverse.app/dm/0x2376-0xf9a3/14","metadata":{}}},{"version":"v2","topic":"/xmtp/0/m-AXCw-t6We7V1fe4ptKK1NyeLLChr3hF6gXscq5XS9Aw/proto","keyMaterial":"nhcc3bUXJ6KzLex2XnbHV86qUfPOm+WWb9mhuGOZdSA=","peerAddress":"0xf9a3BB070c1f9b3186A547DeD991BeD04a289C5B","createdAt":"2023-01-05T09:03:49.708Z","context":{"conversationId":"getconverse.app/dm/0x2376-0xf9a3/15","metadata":{}}},{"version":"v2","topic":"/xmtp/0/m-VCifYEW+ZJCUI9WAE3kc-pzI2YzVemORmwl0ysaS2GE/proto","keyMaterial":"9eZBMBcEombMnUQvu3Ld3LllvIW8mH5NnwB+9lCuyR0=","peerAddress":"0xf9a3BB070c1f9b3186A547DeD991BeD04a289C5B","createdAt":"2023-01-05T09:06:40.316Z","context":{"conversationId":"getconverse.app/dm/0x2376-0xf9a3/16","metadata":{}}},{"version":"v2","topic":"/xmtp/0/m-Bvdny5Zzu9x0YZ7ebzbtRigCn34QG7BLs7qhj-/Z7dg/proto","keyMaterial":"fsl0HpodWy9dKc7lLYVunnJ2LG5bJMzYml5tNmJNRdY=","peerAddress":"0xf9a3BB070c1f9b3186A547DeD991BeD04a289C5B","createdAt":"2023-01-05T09:08:21.545Z","context":{"conversationId":"getconverse.app/dm/0x2376-0xf9a3/17","metadata":{}}},{"version":"v2","topic":"/xmtp/0/m-3SVNOdLHkzJurz14wqGoyX9rSVV70daLqL6jcN70Uls/proto","keyMaterial":"Qyi/8DUYU+WA7f+3Y4wGTW7q6RIj4kdv0n71xVbHluk=","peerAddress":"0xf9a3BB070c1f9b3186A547DeD991BeD04a289C5B","createdAt":"2023-01-05T09:13:56.388Z","context":{"conversationId":"getconverse.app/dm/0xf9a3-0x2376/1","metadata":{}}},{"version":"v2","topic":"/xmtp/0/m-Vu0QnHOSUqlBq0JcCBVykd9yXLw7R7aLuOn4eaLfxwY/proto","keyMaterial":"UVmDvJ6Rqgor0Z3pCB2bJZXN88yJvNEKI2PKb90H4oo=","peerAddress":"0xf9a3BB070c1f9b3186A547DeD991BeD04a289C5B","createdAt":"2023-01-05T09:15:08.124Z","context":{"conversationId":"getconverse.app/dm/0x2376-0xf9a3/18","metadata":{}}},{"version":"v2","topic":"/xmtp/0/m-lXZMa37SwcpsCg2eqgGXQdQbqxyAPFkoc6tTTkeRKqI/proto","keyMaterial":"JRMVxt80MW+NqHQ0n+T6UUrWaQUBOmnLbH44HU0oiRA=","peerAddress":"0xf9a3BB070c1f9b3186A547DeD991BeD04a289C5B","createdAt":"2023-01-05T09:17:31.774Z","context":{"conversationId":"getconverse.app/dm/0x2376-0xf9a3/19","metadata":{}}},{"version":"v2","topic":"/xmtp/0/m-eGvGkzBz-E6zOBSJcjAlO/Z277bV9Pteee2/lIdd7W0/proto","keyMaterial":"fjNsNVwjg869RdDf9TmwWF+qaeICDUHUR1ZvCaZbH3A=","peerAddress":"0xf9a3BB070c1f9b3186A547DeD991BeD04a289C5B","createdAt":"2023-01-05T09:18:03.788Z","context":{"conversationId":"getconverse.app/dm/0x2376-0xf9a3/20","metadata":{}}},{"version":"v2","topic":"/xmtp/0/m-p2TF6JrQl0WhgQcvCT9n+daSNMbY1ybnbzojGNUFNAw/proto","keyMaterial":"UFzwodUkZBBAATWrX6r3TF7CpMTGRLeiXG2YuuLaKcI=","peerAddress":"0x4496848684441C15A915fa9bF07D131155603253","createdAt":"2023-01-06T07:43:05.057Z","context":{"conversationId":"noetest.com","metadata":{}}},{"version":"v2","topic":"/xmtp/0/m-Ceod3oWeShYkfjEndP0f2PUJDsVxJvj20VJZZe2400w/proto","keyMaterial":"h8VTf+1RysMzpYPwQDFtjAFkRCRrUPo5yQ82c+N0Jdw=","peerAddress":"0x4496848684441C15A915fa9bF07D131155603253","createdAt":"2023-01-06T07:43:43.057Z","context":{"conversationId":"noetest.com/2","metadata":{}}},{"version":"v2","topic":"/xmtp/0/m-VHFiEdv6pHWWURwFwXjtFibL2wBkAZqeIat+4gkBDXo/proto","keyMaterial":"6HfRBwZRaoPbI7Pkwjn7pwEGWBsn9bCl+G2mxqpeVfM=","peerAddress":"0x4496848684441C15A915fa9bF07D131155603253","createdAt":"2023-01-06T07:50:20.370Z","context":{"conversationId":"lens.dev/dm/0x5aee-0x5af3-2-lol","metadata":{}}},{"version":"v2","topic":"/xmtp/0/m-YVR0EvQATZO-LPQQUkis+hHDZYx4mJmQ6UIeYGoBBB8/proto","keyMaterial":"KlU/LDBZqIW2dYQmfphj4TD/sAhi1AiJshhijrSghCM=","peerAddress":"0xf9a3BB070c1f9b3186A547DeD991BeD04a289C5B","createdAt":"2023-01-09T10:53:03.069Z","context":{"conversationId":"getconverse.app/dm/0x2376-0xf9a3/21","metadata":{}}}]';
